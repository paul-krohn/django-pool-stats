{% extends "stats/base.html" %}
{% block title %}SFPA :: Tournament :: {{ tournament }}{% endblock %}

{% block content %}
<div id="app">
{% verbatim %}
    <h1>{{ the_tournament.name }}</h1>
    <button type="button" onclick="app.updateData();">update</button>
    <h3>Participants</h3>
    <ul>
    <li v-for="participant in the_tournament.participants">
        <template v-for="(player, index) in participant.players">
            <a :href="player.url">{{ player.name }}</a>
        </template>
    </li>
    </ul>
    <template v-if="the_tournament.elimination != 'single'">
    <div v-for="bracket in the_tournament.brackets" class="brackets">
        <h2>{{ bracket.type }} Bracket</h2>
        <div v-for="round in bracket.rounds">
            <h3>Round {{ round.number }}</h3>
            <ul>
                <li v-for="matchup in round.matchups">
                    <div>{{ bracket.type }}{{ round.number }}/m{{ matchup.number }}
                        <span v-if="matchup.participant_a">
                            <span v-html="renderParticipant (matchup.participant_a)"></span>
                        </span> vs
                        <span v-if="matchup.participant_b">
                            <span v-html="renderParticipant (matchup.participant_b)"></span>
                        </span>
                        <span v-else-if="bracket.type == 'w' && round.number == '1'">bye</span>
                        <span v-else>TBD</span>
                    <span v-if="matchup.winner">winner</span>
                    </div>
                </li>
            </ul>
        </div><!-- end v-for rounds -->
    </div>
    </template>
    <pre>{{ the_tournament }}</pre>
{% endverbatim %}
</div>
<script>
    function checkId(participant, id) {
        return participant.id === id;
    }
    let dataUrl = '{%  url 'tournament' tournament.id %}';
    let app = new Vue({
        el: '#app',
        data: {
            the_tournament: []
        },
        methods: {
            updateData: function() {
                let self = this;
                $.ajax({
                    url: dataUrl,
                    dataType: 'json',
                    success: function(data) {
                        self.the_tournament = data;
                    },
                    headers: {
                        Accept: "application/json",
                    }
                });
            },
            renderParticipant: function(participant) {
                var playerName = 'unknown';
                if (participant !== null) {
                    playerName = participant['players'][0].name;
                }

                console.log("filtering for participant: " + playerName);
                if (participant === null) {
                    return null;
                }

                let player_anchors = Array();
                if (participant.type === 'player') {
                    let the_participant = null;
                    this.the_tournament.participants.forEach(function(a_participant, index){
                        if (a_participant.id === participant.id) {
                            console.log("found it");
                            the_participant = a_participant;
                        }
                    });
                    the_participant.players.forEach(function(player, index) {
                        player_anchors.push(`<a href="${player.url}">${player.name}</a>`);
                    });
                    return player_anchors.join(', ');
                }
            }
        },
        mounted: function() {
            let self = this;
            $.ajax({
                url: dataUrl,
                dataType: 'json',
                success: function(data) {
                    self.the_tournament = data;
                },
                headers: {
                    Accept: "application/json",
                }
            });
        }
    })
</script>
{% endblock %}
