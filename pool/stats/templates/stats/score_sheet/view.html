
{% block content %}

<!--
    the csrftoken is read below in javascript to satisfy django's anti-csrf implementation,
    See: https://docs.djangoproject.com/en/2.1/ref/csrf/
-->
{% csrf_token %}

<style>
    .game_wrapper {
        /* display: inline-flex; */
        /*border-width: 2px;
        border-color: #B444B4;
        border-style: solid; */
        padding: 2px;
        margin: 2px;
        font-weight: normal !important;
    }
    .game_player {
        padding: 2px;
        float: left;
        display: table-cell;
        vertical-align: middle;
    }
    .game_players {
        padding: 2px;
    }
    .game_winner {

    }

    .game_attributes {
        padding: 2px;
        float: right;
        display: table-cell;
        vertical-align: middle;
    }

    .game_input {
        vertical-align: middle !important;
    }

    .game_order {
        color: #444444;
        width: 28px;
        height: 28px;
        text-align: center;
        display: table-cell;
        vertical-align: middle;
    }
    .game_attribute {
        float: left;
        vertical-align: middle !important;
        padding: 2px;
    }

    div.game_number {
        vertical-align: middle;
        width: 26px;
        font-size: small;
    }

    .game_winner_button {
        vertical-align: middle;
        width: 26px;
    }

    div.scoresheet-cell {
        vertical-align: middle !important;
        padding: 4px !important;
        float:  left;
    }
    div.scoresheet-cell-right {
        vertical-align: middle !important;
        padding: 4px !important;
        float:  right;
    }

    .play-position {
        float: left;
        font-weight: bold;
        width: 28px;
        height: 28px;
        border: #444444 solid;
        text-align: center;
        vertical-align: middle !important;
    }

    .mark-nobreak-position, .mark-break-position {
        font-weight: bold;
        width: 28px;
        height: 28px;
    }

    .break-position {
        background-color: #444444;
        color: #FFFFFF;
    }

    .team-name {
        font-size: x-large;
        white-space: nowrap;
    }

</style>


<div id="scoresheet" class="container-fluid">
    {% verbatim %}
    <div class=" team-name">
        <a :href="teams.away.url">{{ teams.away.name }}</a> {{ teams.away.wins }}
    </div>
    <div class=" team-name">
        <a :href="teams.home.url">{{ teams.home.name }}</a> {{ teams.home.wins }}
    </div>
    {% endverbatim %}
    <div>
        <input @click="toggleGameDetails();" id="toggle-game-details" type="button" class="btn btn-default" value="game details" />
    </div>
    <div v-for="game in games" :class="gameWrapperClasses(game.order.order + 1)"
         :id="'game-wrapper-' + game.id">
            <div class="game_player col-xs-2">
                <div class="scoresheet-cell-right">
                    <a v-if="game.away_player" :href="game.away_player.url">
                        <span v-html="game.away_player.name"></span>
                    </a>
                </div>
            </div>
            <div style="min-width: 210px" class="col-md-2">
                <div class="scoresheet-cell">
                    <div class=" play-position" :class="{ 'break-position' : !game.order.home_breaks}"
                         v-html="game.order.away_position"></div>
                </div>
                <form method="POST" :target="gameFormUrl" :disabled="! editable">
                <div class="scoresheet-cell">
                    <input class="game_winner_button" type="radio" :id="'game-winner-away-' + game.id"
                        value="away" v-model="game.winner" :disabled="! editable"
                        @change="submitGame(game)"
                    >
                </div>
                <div class="scoresheet-cell">
                    <div class="game_order" v-html="game.order.order"></div>
                </div>

                <div class="scoresheet-cell">
                    <input type="radio"  class="game_winner_button" :id="'game-winner-home-' + game.id"
                        value="home" v-model="game.winner" :disabled="! editable"
                        @change="submitGame(game)"
                    />
                </div>
                </form>
                <div class="scoresheet-cell">
                    <div class="play-position" :class="{ 'break-position' : game.order.home_breaks}"
                         v-html="game.order.home_position"></div>
                </div>
            </div>
            <div class="game_player col-md-2">
                <div class="scoresheet-cell">
                    <a v-if="game.home_player" :href="game.home_player.url">
                        <span v-html="game.home_player.name"></span>
                    </a>
                </div>
            </div>
            <div style="float: right" class="game_attributes scoresheet-cell col-md-2 col-xs-12">
                <div class="game_attribute ">
                    <input type="checkbox" :id="'game-tr-' + game.id" v-model="game.table_run"
                            :disabled="! editable"
                            @change="submitGame(game)"
                    />
                    <label :for="'game-tr-' + game.id">tr </label>
                </div>
                <div class="game_attribute">
                    <input type="checkbox" :id="'game-forfeit-' + game.id" v-model="game.forfeit"
                        :disabled="! editable"
                        @change="submitGame(game)"
                    />
                    <label :for="'game-forfeit-' + game.id">forfeit </label>
                </div>
                <div class="game_attribute">
                    {% verbatim %}
                    <span v-if="game.timestamp" v-html="displayDate(game.timestamp)"></span>
                    {% endverbatim %}
                </div>
            </div>
    </div>
    <div class="row">
        <div class="col-md-4" v-for="team in teams">
            <table style="width: auto;" class="table table-striped table-responsive">
                <thead>
                    <tr>
                        <th style="white-space: nowrap;" v-html="team.name"></th>
                        <th>W</th>
                        <th>L</th>
                        <th>TRs</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="player in team.players">
                        {% verbatim %}
                        <td style="white-space: nowrap;"><a :href="player.player.url">{{ player.player.name }}</a></td>
                        <td>{{ player.wins }}</td>
                        <td>{{ player.losses }}</td>
                        <td>{{ player.table_runs }}</td>
                        {% endverbatim %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

let csrftoken = $("input[name='csrfmiddlewaretoken']").val();

let app = new Vue({
    el: '#scoresheet',
    data: {
        games: [],
        teams: {},
        editable: false,
        gameFormUrl: '{% url 'game_update' %}',
        dataUrl: '{% url 'score_sheet_summary' score_sheet.id %}',
    },
    methods: {
        updateData: function() {
            let self = this;
            $.ajax({
                url: this.dataUrl,
                dataType: 'json',
                success: function(data) {
                    self.teams = data.teams;
                    self.games = data.games;
                    self.editable = data.editable;
                },
                headers: {
                    Accept: "application/json",
                }
            });
        },
        displayDate: function (dateString) {
            let timestamp = new Date(dateString);
            return timestamp.toLocaleTimeString('en-US', {timeStyle: 'short'});
        },
        isOdd: function(number) {
            return number % 2;
        },
        gameWrapperClasses: function(number){
            let base_classes = ['row', 'game_wrapper', 'container-fluid'];
            if (this.isOdd(number)) {
                base_classes.push('scoresheet-odd');
            }
            return base_classes.join(' ');
        },
        matchupButtonId: function (matchup, participant) {
            return ("matchup_button_" + matchup.id + '_' + participant.id);
        },
        submitGame: function(game) {
            let self = this;
            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                },
                dataType: 'application/json',
            });
            $.ajax({
                type: "POST",
                url: "{% url 'game_update' %}",
                dataType: "json",
                data: {
                    "game_id": game.id,
                    "winner": game.winner,
                    "table_run": game.table_run,
                    "forfeit": game.forfeit,
                },
                success: function(response) {
                    self.updateData();
                },
            });
        },
        toggleGameDetails: function() {
            $(".game_attributes").each(function(i, aDiv){
                if ($(aDiv).css('display') === 'none') {
                    $(aDiv).css('display', 'block');
                } else {
                    $(aDiv).css('display', 'none');
                }
            });
        },
    },
    mounted: function() {
        this.updateData();
    },
});

</script>

{% endblock %}
