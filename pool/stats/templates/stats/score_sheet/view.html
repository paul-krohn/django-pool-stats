
{% block content %}

<!--
    the csrftoken is read below in javascript to satisfy django's anti-csrf implementation,
    See: https://docs.djangoproject.com/en/2.1/ref/csrf/
-->
{% csrf_token %}

    <style>
    .game_wrapper {
        display: inline-flex;
        border-width: 2px;
        border-color: #B444B4;
        border-style: solid;
        padding: 2px;
        margin: 2px;
        font-weight: normal;
    }
    .game_player {
        float: left;
    }
    .game_winner {

    }
    </style>
<h1>{{ tournament.name }}</h1>

    <div id="games">
    <div v-for="game in games" class="game_wrapper">
        <form method="POST" :id="game.id" :target="gameFormUrl" :disabled="! editable">
            <div class="game_players">
                <div class="game_player">
                    <input type="radio" :id="'game-winner-home-' + game.id"
                       value="home" v-model="game.winner" :disabled="! editable"
                       @change="submitGame(game)"
                    />
                    <label :for="'game-winner-home-' + game.id">
                        <a :href="game.home_player.url">
                            <span v-html="game.home_player.name"></span>
                        </a>
                    </label>
                </div>
                <div class="game_player ">
                    <input type="radio" :id="'game-winner-away-' + game.id"
                           value="away" v-model="game.winner" :disabled="! editable"
                           @change="submitGame(game)"
                    >
                    <label :for="'game-winner-away-' + game.id">
                        <a :href="game.away_player.url">
                            <span v-html="game.away_player.name"></span>
                        </a>
                    </label>
                </div>
            </div>
            <div class="game_attributes">
                <div class="game_attribute">
                    <label :for="'game-tr-' + game.id">tr </label>
                    <input type="checkbox" :id="'game-tr-' + game.id" v-model="game.table_run"
                            :disabled="! editable"
                            @change="submitGame(game)"
                    />
                </div>
                <div class="game_attribute">
                    <label :for="'game-forfeit-' + game.id">forfeit </label>
                    <input type="checkbox" :id="'game-forfeit-' + game.id" v-model="game.forfeit"
                        :disabled="! editable"
                        @change="submitGame(game)"
                    />
                </div>
            </div>
        </form>
    </div>
    {% verbatim %}
    {%  endverbatim %}
</div>

<script>
function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

let dataUrl = '{% url 'score_sheet_games' score_sheet.id %}';
let csrftoken = $("input[name='csrfmiddlewaretoken']").val();

let app = new Vue({
    el: '#games',
    data: {
        games: [],
        editable: false,
        gameFormUrl: '{% url 'game_update' %}',
    },
    methods: {
        matchupButtonId: function (matchup, participant) {
            return ("matchup_button_" + matchup.id + '_' + participant.id);
        },
        submitGame: function(game) {
            //    console.log("we are about to set the winner of matchup " + matchup.id + " to " + winner.id);
            //    let the_id = this.matchupButtonId(matchup, winner);
            //    console.log("the id is: " + the_id);
            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                },
                dataType: 'application/json',
            });
            $.post("{% url 'game_update' %}", {
                "game_id": game.id,
                "winner": game.winner,
                "table_run": game.table_run,
                "forfeit": game.forfeit,
            });
            // this.updateData();
        },

    },
    mounted: function() {
        let self = this;
        $.ajax({
            url: dataUrl,
            dataType: 'json',
            success: function(data) {
                self.games = data.games;
                self.editable = data.editable;
            },
            headers: {
                Accept: "application/json",
            }
        });
    },
});

</script>

{% endblock %}
